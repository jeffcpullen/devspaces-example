## Based on https://github.com/cgruver/ocp-4-18-nested-container-tech-preview/blob/main/devfile.yaml

schemaVersion: 2.2.0
attributes:
  controller.devfile.io/storage-type: per-workspace
metadata:
  name: ansible-devspaces-example
# You can store your devfile in one repository, and then add additional repositories
# as shown below to be automatically added into your workspace
# projects:
#   - name: sample-collection-repo
#     git:
#       remotes:
#         origin: 'https://github.com/ansible-collections/kubernetes.core'
#   - name: sample-multi-repo-project
#     git:
#       remotes:
#         origin: 'https://github.com/containers/podman'
#       checkoutFrom:
#         revision: main
components:
  - name: dev-tools
    attributes:
      pod-overrides:
        metadata:
          annotations:
            # Ask for /dev/fuse and /dev/net/tun to be mapped into this Pod
            io.kubernetes.cri-o.Devices: "/dev/fuse,/dev/net/tun"
        spec:
          # Instruct the container runtime to create a new user namespace for the containers in this Pod.
          hostUsers: false
      container-overrides:
        securityContext:
          # Ask for an unmasked /proc to be available to this container
          procMount: Unmasked
    container:
      image: quay.io/jpullen0/ansible-devspaces-nested-podman:latest
      # image: quay.io/cgruver0/che/ocp-4-17-userns-tp:latest
      cpuLimit: 4000m
      cpuRequest: 250m
      memoryLimit: 4Gi
      memoryRequest: 128Mi
      env:
        - name: VSCODE_DEFAULT_WORKSPACE
          value: /projects/devspaces-example/devspaces.code-workspace
  - name: prep-workspace
    container:
      args:
        - '-c'
        - >-
          mkdir -p /projects/bin && cp /usr/bin/oc /projects/bin/oc && cp /usr/bin/kubectl /projects/bin/kubectl && if [[ -f ${HOME}/.kube/config ]]; then rm ${HOME}/.kube/config; fi
      command:
        - /bin/bash
      image: image-registry.openshift-image-registry.svc:5000/openshift/cli:latest
      mountSources: true
      sourceMapping: /projects
      memoryRequest: 128Mi
      memoryLimit: 256Mi
      cpuRequest: 10m
      cpuLimit: 200m
      env:
      - name: HOME
        value: "/projects/home"
commands:
  - apply:
      component: prep-workspace
      label: Pre Start Prep
    id: prep-workspace
events:
  preStart:
    - prep-workspace
